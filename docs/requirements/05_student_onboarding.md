# 5. 生徒の新規登録フロー

## 5-1. スプレッドシートからの自動取り込み

- **概要:** 別システムの Google フォームから出力されるスプレッドシートを定期的に監視し、新しい生徒情報を自動でシステムに登録する。
- **実装方法:**
  - **Vercel Cron Jobs** を利用して、API ルートを定期的に（例: 1 時間に 1 回）実行する。
  - API ルートは、リクエストヘッダーに含まれる Cron Secret を検証し、不正なアクセスを拒否する。
  - Google Sheets API からデータを取得し、Supabase クライアントライブラリを使って`students`テーブルにデータを挿入する。
  - メールアドレスなどの一意項目が既に登録済みの行は重複としてスキップする。
  - 取り込み済みの行にはシート側で処理済みマーク（例: `imported` 列に `true`）を付与し、次回以降の取り込み対象から除外する。

## 5-2. CSV ファイルからの手動インポート

- **概要:** 管理者（Admin 以上）が、CSV ファイルを使って複数の生徒情報を一括で登録する機能。
- **アクセス権限:** Admin, SystemAdmin
- **配置場所:** 管理者向け画面エリア

### UI/UX 設計

- **画面タイトル:** 生徒 CSV インポート
- **ファイル選択エリア:**
  - 「ファイルを選択」ボタンを配置。選択できるのは`.csv`ファイルのみ。
- **アップロードボタン:**
  - 「アップロードして登録」ボタン。
- **CSV フォーマット説明:**
  - ヘッダーと列順（固定）:
    1. `name` - 生徒氏名
    2. `kana_name` - フリガナ
    3. `grade` - 学年
    4. `email` - メールアドレス
    5. `phone` - 電話番号
  - 保護者に関する情報は本 CSV の対象外。
- **結果表示エリア:**
  - アップロード後、「XX 件の登録に成功しました」「XX 件がエラーでした（詳細は以下の通り）」といった結果を表示する。

### 機能仕様

1. アップロードされた CSV ファイルを解析する。
2. エラー行以外を先に登録する部分コミット方式で、各行のデータを`students`テーブルに登録する。
3. エラーが発生した行については、行番号とエラー内容（例: 「メールアドレスの形式が不正です」）を画面にフィードバックする。

### 役割定義への参照

- 本機能のアクセス権限で登場する **SystemAdmin** と **Admin** の詳細な役割は、[権限マトリクス](../architecture/permission_matrix.md) を参照。
